<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Improving calls to the LogGabor library | Scientific logbook</title>
<link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../rss.xml">
<link rel="canonical" href="https://laurentperrinet.github.io/sciblog/posts/2017-10-06-improving-calls-to-the-loggabor-library.html">
<link rel="icon" href="favicon.ico" sizes="16x16">
<!--[if lt IE 9]><script src="../assets/js/html5.js"></script><![endif]--><meta name="author" content="Laurent Perrinet">
<link rel="prev" href="2017-09-20-the-fastest-2d-convolution-in-the-world.html" title="The fastest 2D convolution in the world" type="text/html">
<link rel="next" href="2017-10-25-designing-a-a0-poster-using-matplotlib.html" title="Designing a A0 poster using matplotlib" type="text/html">
<meta property="og:site_name" content="Scientific logbook">
<meta property="og:title" content="Improving calls to the LogGabor library">
<meta property="og:url" content="https://laurentperrinet.github.io/sciblog/posts/2017-10-06-improving-calls-to-the-loggabor-library.html">
<meta property="og:description" content="To code image as edges, for instance in the SparseEdges sparse coding scheme, we use a model of edges in images. A good model for these edges are bidimensional Log Gabor filter. This is implemented fo">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-10-06T11:04:04+02:00">
<meta property="article:tag" content="ipython">
<meta property="article:tag" content="learning">
<meta property="article:tag" content="LogGabor">
<meta property="article:tag" content="Matching Pursuit">
<meta property="article:tag" content="numpy">
<meta property="article:tag" content="python">
<meta property="article:tag" content="SLIP">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
<!-- Custom search -->
<form method="get" id="search" action="//duckduckgo.com/" class="navbar-form pull-left">
<input type="hidden" name="sites" value="https://laurentperrinet.github.io/sciblog/"><input type="hidden" name="k8" value="#444444"><input type="hidden" name="k9" value="#D51920"><input type="hidden" name="kt" value="h"><input type="text" name="q" maxlength="255" placeholder="Search…" class="span2" style="margin-top: 4px;"><input type="submit" value="DuckDuckGo Search" style="visibility: hidden;">
</form>
<!-- End of custom search -->

            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="../">

            <span id="blog-title">Scientific logbook</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav">
<li class="nav-item">
    <a href="2017-10-06-improving-calls-to-the-loggabor-library.ipynb" id="sourcelink" class="nav-link">Source</a>
    </li>


                    
            </ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="../index.html" class="nav-link">Home</a>
                </li>
<li class="nav-item">
<a href="../archive.html" class="nav-link">Archives</a>
                </li>
<li class="nav-item">
<a href="../categories/index.html" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../rss.xml" class="nav-link">RSS</a>
                </li>
<li class="nav-item">
<a href="http://laurentperrinet.github.io" class="nav-link">About my research</a>
                </li>
<li class="nav-item">
<a href="https://twitter.com/laurentperrinet" class="nav-link">Twitter</a>
                </li>
<li class="nav-item">
<a href="https://github.com/laurentperrinet" class="nav-link">Github</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Improving calls to the LogGabor library</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Laurent Perrinet
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2017-10-06T11:04:04+02:00" itemprop="datePublished" title="2017-10-06 11:04">2017-10-06 11:04</time></a>
            </p>
            
        <p class="sourceline"><a href="2017-10-06-improving-calls-to-the-loggabor-library.ipynb" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To code image as edges, for instance in the <code>SparseEdges</code> <a href="https://github.com/bicv/SparseEdges">sparse coding scheme</a>, we use a model of edges in images. A good model for these edges are <a href="https://en.wikipedia.org/wiki/Log_Gabor_filter#Bi-dimensional_Log-Gabor_filter">bidimensional Log Gabor filter</a>. This is implemented for instance in the <code>LogGabor</code> library. The library was designed to be precise, but not particularly for efficiency. In order to improve its speed, we demonstrate here the use of a cache to avoid redundant computations.</p>
<!-- TEASER_END -->

<p>Let's first initialize the notebook:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="o">%</span><span class="k">load_ext</span> line_profiler
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="timing-of-the-library-without-cache">timing of the library without cache<a class="anchor-link" href="2017-10-06-improving-calls-to-the-loggabor-library.html#timing-of-the-library-without-cache">¶</a>
</h3>
<p>Let's make calls to the library and record the wall clock timing:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">LogGabor</span> <span class="kn">import</span> <span class="n">LogGabor</span>
<span class="n">lg</span> <span class="o">=</span> <span class="n">LogGabor</span><span class="p">(</span><span class="s1">'https://raw.githubusercontent.com/bicv/SparseEdges/master/default_param.py'</span><span class="p">)</span>
<span class="n">lg</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">use_cache</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">lg</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">lg</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>it
<span class="n">edge</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">lg</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">lg</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_Y</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">FT_lg</span> <span class="o">=</span> <span class="n">lg</span><span class="o">.</span><span class="n">loggabor</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sf_0</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">sf_0</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">B_sf</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">B_sf</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">B_theta</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">B_theta</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>7.77 ms ± 1.32 ms per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre>
</div>
</div>

</div>
</div>

</div>%lprun -s -m LogGabor lg.loggabor(0, 0, sf_0=lg.sf_0[2], B_sf=lg.pe.B_sf, theta=lg.theta[2], B_theta=lg.pe.B_theta)
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note that most of the time, we compute the filter at the origin and that whenever it is the case we avoid performing the translation. This makes the call systematically faster:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>it
<span class="n">edge</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">FT_lg</span> <span class="o">=</span> <span class="n">lg</span><span class="o">.</span><span class="n">loggabor</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sf_0</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">sf_0</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">B_sf</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">B_sf</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">B_theta</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">B_theta</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>3.49 ms ± 259 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Using-a-cache">Using a cache<a class="anchor-link" href="2017-10-06-improving-calls-to-the-loggabor-library.html#Using-a-cache">¶</a>
</h3>
<p>We will use the fact that the many calls to the logGabor library repeat the same operation. We can cache the computed matrices instead of repeating the operation. In particular, we will take advantage of using scales (bands) and orientation separately, the multiplication being rapid in numpy.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lg</span> <span class="o">=</span> <span class="n">LogGabor</span><span class="p">(</span><span class="s1">'https://raw.githubusercontent.com/bicv/SparseEdges/master/default_param.py'</span><span class="p">)</span>
<span class="n">lg</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">use_cache</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">lg</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">lg</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">'Dictionary that will contain the matrices='</span><span class="p">,</span> <span class="n">lg</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Dictionary that will contain the matrices= {'band': {}, 'orientation': {}}
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In the beginning, the cache is empty but every time with compute one matrix, it gets filled up:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">edge</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">FT_lg</span> <span class="o">=</span> <span class="n">lg</span><span class="o">.</span><span class="n">loggabor</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sf_0</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">sf_0</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">B_sf</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">B_sf</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">B_theta</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">B_theta</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">'Dictionary that contains the matrices='</span><span class="p">,</span> <span class="n">lg</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>doing band cache for tag  0.189503126127_0.4
doing orientation cache for tag  -1.1780972451_0.17453277777777776
Dictionary that contains the matrices= {'band': {'0.189503126127_0.4': array([[ 0.006271,  0.006501,  0.006738, ...,  0.006984,  0.006738,
         0.006501],
       [ 0.006501,  0.00674 ,  0.006988, ...,  0.007244,  0.006988,
         0.00674 ],
       [ 0.006738,  0.006988,  0.007246, ...,  0.007513,  0.007246,
         0.006988],
       ..., 
       [ 0.006984,  0.007244,  0.007513, ...,  0.007792,  0.007513,
         0.007244],
       [ 0.006738,  0.006988,  0.007246, ...,  0.007513,  0.007246,
         0.006988],
       [ 0.006501,  0.00674 ,  0.006988, ...,  0.007244,  0.006988,
         0.00674 ]])}, 'orientation': {'-1.1780972451_0.17453277777777776': array([[  2.857228e+05,   2.536583e+05,   2.249385e+05, ...,
          7.830696e-14,   7.439627e-14,   7.074259e-14],
       [  3.217782e+05,   2.857228e+05,   2.534195e+05, ...,
          7.445581e-14,   7.077041e-14,   6.732618e-14],
       [  3.626499e+05,   3.220804e+05,   2.857228e+05, ...,
          7.079868e-14,   6.732618e-14,   6.407993e-14],
       ..., 
       [  1.720206e+13,   1.639461e+13,   1.561163e+13, ...,
          3.499896e-06,   3.101855e-06,   2.752276e-06],
       [  1.638199e+13,   1.560551e+13,   1.485306e+13, ...,
          3.949803e-06,   3.499896e-06,   3.104815e-06],
       [  1.559949e+13,   1.485306e+13,   1.413020e+13, ...,
          4.454120e-06,   3.946026e-06,   3.499896e-06]])}}
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>it
<span class="n">edge</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">lg</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">lg</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_Y</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">FT_lg</span> <span class="o">=</span> <span class="n">lg</span><span class="o">.</span><span class="n">loggabor</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sf_0</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">sf_0</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">B_sf</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">B_sf</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">B_theta</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">B_theta</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>5.12 ms ± 1.9 ms per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>it
<span class="n">edge</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">FT_lg</span> <span class="o">=</span> <span class="n">lg</span><span class="o">.</span><span class="n">loggabor</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sf_0</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">sf_0</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">B_sf</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">B_sf</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">B_theta</span><span class="o">=</span><span class="n">lg</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">B_theta</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>486 µs ± 48.3 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>That's a great improvement! Let's now apply that to the Matching Pursuit algorithm implemented in the <code>SparseEdges</code> library:</p>
<h3 id="application-to-SparseEdges">application to SparseEdges<a class="anchor-link" href="2017-10-06-improving-calls-to-the-loggabor-library.html#application-to-SparseEdges">¶</a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">SparseEdges</span> <span class="kn">import</span> <span class="n">SparseEdges</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">SparseEdges</span><span class="p">(</span><span class="s1">'https://raw.githubusercontent.com/bicv/SparseEdges/master/default_param.py'</span><span class="p">)</span>
<span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="mi">32</span> <span class="c1"># number of edges</span>
<span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">use_cache</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">mp</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

<span class="c1"># defining a test image</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_Y</span><span class="p">))</span>
<span class="n">image</span><span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">4</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">image</span><span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">4</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">4</span><span class="p">:</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [10]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>it -n1 -r1
<span class="n">edges</span><span class="p">,</span> <span class="n">C_res</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">run_mp</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>2min 1s ± 0 ns per loop (mean ± std. dev. of 1 run, 1 loop each)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">SparseEdges</span> <span class="kn">import</span> <span class="n">SparseEdges</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">SparseEdges</span><span class="p">(</span><span class="s1">'https://raw.githubusercontent.com/bicv/SparseEdges/master/default_param.py'</span><span class="p">)</span>
<span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="mi">32</span> <span class="c1"># number of edges</span>
<span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">use_cache</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">mp</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

<span class="c1"># defining a test image</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_Y</span><span class="p">))</span>
<span class="n">image</span><span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">4</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">image</span><span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">4</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">4</span><span class="p">:</span><span class="n">mp</span><span class="o">.</span><span class="n">pe</span><span class="o">.</span><span class="n">N_X</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [12]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>it -n1 -r1
<span class="n">edges</span><span class="p">,</span> <span class="n">C_res</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">run_mp</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>1min 41s ± 0 ns per loop (mean ± std. dev. of 1 run, 1 loop each)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Which shows a performance gain of approximately 25%. These changes are now effective in the code (see <a href="https://github.com/bicv/LogGabor/commit/05b81deda5993e14583a84b3d56d7aaf1adc51f1">this commit</a>).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Further profiling shows that most of the time is spend in the <code>backprop</code>function:</p>

</div>
</div>
</div>%lprun -m SparseEdges edges, C_res = mp.run_mp(image, verbose=False)
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="some-book-keeping-for-the-notebook">some book keeping for the notebook<a class="anchor-link" href="2017-10-06-improving-calls-to-the-loggabor-library.html#some-book-keeping-for-the-notebook">¶</a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [13]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> watermark
<span class="o">%</span><span class="k">watermark</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>2017-10-25T15:08:31+02:00

CPython 3.6.3
IPython 6.1.0

compiler   : GCC 4.2.1 Compatible Apple LLVM 9.0.0 (clang-900.0.37)
system     : Darwin
release    : 17.0.0
machine    : x86_64
processor  : i386
CPU cores  : 4
interpreter: 64bit
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [14]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> version_information
<span class="o">%</span><span class="k">version_information</span> numpy, scipy, matplotlib, sympy, pillow, imageio
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[14]:</div>



<div class="output_html rendered_html output_subarea output_execute_result"><table>
<tr>
<th>Software</th>
<th>Version</th>
</tr>
<tr>
<td>Python</td>
<td>3.6.3 64bit [GCC 4.2.1 Compatible Apple LLVM 9.0.0 (clang-900.0.37)]</td>
</tr>
<tr>
<td>IPython</td>
<td>6.1.0</td>
</tr>
<tr>
<td>OS</td>
<td>Darwin 17.0.0 x86_64 i386 64bit</td>
</tr>
<tr>
<td>numpy</td>
<td>1.13.1</td>
</tr>
<tr>
<td>scipy</td>
<td>0.19.1</td>
</tr>
<tr>
<td>matplotlib</td>
<td>2.0.2</td>
</tr>
<tr>
<td>sympy</td>
<td>1.1.1</td>
</tr>
<tr>
<td>pillow</td>
<td>4.2.1</td>
</tr>
<tr>
<td>imageio</td>
<td>2.1.2</td>
</tr>
<tr><td colspan="2">Wed Oct 25 15:08:32 2017 CEST</td></tr>
</table></div>

</div>

</div>
</div>

</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../categories/ipython.html" rel="tag">ipython</a></li>
            <li><a class="tag p-category" href="../categories/learning.html" rel="tag">learning</a></li>
            <li><a class="tag p-category" href="../categories/loggabor.html" rel="tag">LogGabor</a></li>
            <li><a class="tag p-category" href="../categories/matching-pursuit.html" rel="tag">Matching Pursuit</a></li>
            <li><a class="tag p-category" href="../categories/numpy.html" rel="tag">numpy</a></li>
            <li><a class="tag p-category" href="../categories/python.html" rel="tag">python</a></li>
            <li><a class="tag p-category" href="../categories/slip.html" rel="tag">SLIP</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="2017-09-20-the-fastest-2d-convolution-in-the-world.html" rel="prev" title="The fastest 2D convolution in the world">Previous post</a>
            </li>
            <li class="next">
                <a href="2017-10-25-designing-a-a0-poster-using-matplotlib.html" rel="next" title="Designing a A0 poster using matplotlib">Next post</a>
            </li>
        </ul></nav></aside><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha384-3lJUsx1TJHt7BA4udB5KPnDrlkO8T6J6v/op7ui0BbCjvZ9WqV4Xm6DTP6kQ/iBH" crossorigin="anonymous"></script><script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
    },
    displayAlign: 'center', // Change this to 'center' to center equations.
    "HTML-CSS": {
        styles: {'.MathJax_Display': {"margin": 0}}
    }
});
</script></article><!--End of body content--><footer id="footer">
            Contents © 2022 <a href="mailto:laurent.perrinet@univ-amu.fr">Laurent Perrinet</a> -
Powered by <a href="http://getnikola.com">Nikola</a>.<br><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/2.5/ar/">
<img alt="Creative Commons License BY-NC-SA" style="border-width:0; margin-bottom:12px;" src="http://i.creativecommons.org/l/by-nc-sa/2.5/ar/88x31.png"></a>
            
            
        </footer>
</div>
</div>


        <script src="../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-140381649-1"></script><script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));
  }

  gtag('js', new Date());
  gtag('config', 'UA-140381649-1', {});


  document.addEventListener('click', onClickCallback, false);
</script>
</body>
</html>
